<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="cn.relaxtech.doomsday.bi.boot.dao.bi.BiLtvDataDao">
    <!--auto generated Code-->
    <resultMap id="AllColumnMap" type="cn.relaxtech.doomsday.bi.boot.entity.bi.BiLtvData">
        <result column="id" property="id"/>
        <result column="job_date" property="jobDate"/>
        <result column="server_id" property="serverId"/>
        <result column="country" property="country"/>
        <result column="cname" property="cname"/>
        <result column="T" property="T"/>
        <result column="channel" property="channel"/>
        <result column="device_type" property="deviceType"/>
        <result column="PUC" property="PUC"/>
        <result column="NUC" property="NUC"/>
        <result column="PAC" property="PAC"/>
        <result column="LTV1" property="LTV1"/>
        <result column="LTV2" property="LTV2"/>
        <result column="LTV3" property="LTV3"/>
        <result column="LTV4" property="LTV4"/>
        <result column="LTV5" property="LTV5"/>
        <result column="LTV6" property="LTV6"/>
        <result column="LTV7" property="LTV7"/>
        <result column="LTV14" property="LTV14"/>
        <result column="LTV21" property="LTV21"/>
        <result column="LTV30" property="LTV30"/>
        <result column="LTV60" property="LTV60"/>
        <result column="LTV90" property="LTV90"/>
    </resultMap>

    <!--auto generated Code-->
    <sql id="all_column">
        `id`,
        `job_date`,
        `server_id`,
        `country`,
        `cname`,
        `T`,
        `channel`,
        `device_type`,
        `PUC`,
        `NUC`,
        `PAC`,
        `LTV1`,
        `LTV2`,
        `LTV3`,
        `LTV4`,
        `LTV5`,
        `LTV6`,
        `LTV7`,
        `LTV14`,
        `LTV21`,
        `LTV30`,
        `LTV60`,
        `LTV90`
    </sql>


    <select id="getList" parameterType="cn.relaxtech.doomsday.bi.boot.entity.bi.SearchParams" resultMap="AllColumnMap">
        SELECT
        job_date,
        sum(NUC) AS NUC,
        sum(puc) as PUC,
        sum(PAC) as PAC,
        ROUND(sum(PAC1)/NUC,2) as LTV1,
        ROUND(sum(PAC2)/NUC,2) as LTV2,
        ROUND(sum(PAC3)/NUC,2) as LTV3,
        ROUND(sum(PAC4)/NUC,2) as LTV4,
        ROUND(sum(PAC5)/NUC,2) as LTV5,
        ROUND(sum(PAC6)/NUC,2) as LTV6,
        ROUND(sum(PAC7)/NUC,2) as LTV7,
        ROUND(sum(PAC14)/NUC,2) as LTV14,
        ROUND(sum(PAC21)/NUC,2) as LTV21,
        ROUND(sum(PAC30)/NUC,2) as LTV30,
        ROUND(sum(PAC60)/NUC,2) as LTV60,
        ROUND(sum(PAC90)/NUC,2) as LTV90
        FROM view_bi_ltv_data
        <where>
            <if test="startDate != null and endDate !=null" >
                job_date BETWEEN #{startDate}  AND #{endDate}
            </if>

            <if test="country != null and country[0]!='ALL' and country.size()>0" >
                AND country in
                <foreach collection="country" item="item" open="(" close=")" separator="," index="index">
                    #{item}
                </foreach>
            </if>

            <if test="channel != null and channel[0]!='ALL' and channel.size()>0" >
                AND channel in
                <foreach collection="channel" item="item" open="(" close=")" separator="," index="index">
                    #{item}
                </foreach>
            </if>

            <if test="deviceType != null and deviceType!=0 " >
                AND device_Type=#{deviceType}
            </if>
        </where>
        group by job_date
        order by job_date desc
    </select>

</mapper>

